<div class="role-row {% if assign.status == 'swap_needed' %}row-swap-needed{% endif %}"
    id="row-{{ full_date | replace(',','') | replace(' ','') }}-{{ assign.idx }}" data-name="{{ assign.person }}">

    <div class="role-content">
        <div class="role-left">
            {% set r = assign.role %}
            <span class="role-icon">
                {% if r == 'Computer' %}<i class="fas fa-desktop"></i>
                {% elif r == 'Camera 1' %}<i class="fas fa-video"></i>
                {% elif r == 'Camera 2' %}<i class="fas fa-video"></i>
                {% else %}<i class="fas fa-users"></i>
                {% endif %}
            </span>

            {% if is_manager %}
            <form hx-post="/update_person" hx-swap="outerHTML"
                hx-target="#row-{{ full_date | replace(',','') | replace(' ','') }}-{{ assign.idx }}"
                style="margin:0; flex-grow:1;" onclick="event.stopPropagation()">
                <input type="hidden" name="date" value="{{ full_date }}">
                <input type="hidden" name="role_idx" value="{{ assign.idx }}">
                <select name="new_person" onchange="this.form.requestSubmit()" class="modern-select"
                    style="padding:0; margin:0; width:100%; background:transparent; border:none; font-weight:500; color:{% if assign.person == 'Select Helper' %}var(--open-text){% else %}#e2e8f0{% endif %};">
                    {% if assign.person == 'Select Helper' %}
                    <option value="Select Helper" disabled selected>Unassigned</option>
                    {% endif %}
                    {% for name in all_names %}
                    <option value="{{ name }}" {% if name==assign.person %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </form>
            {% else %}
            {% if assign.person == 'Select Helper' %}
            <span class="person-name unassigned">Needed</span>
            {% else %}
            {% if assign.swapped_with %}
            <span class="person-name">
                <s style="opacity:.6;">{{ assign.swapped_with }}</s>
                <span class="swap-indicator">(â‡„ {{ assign.person }})</span>
            </span>
            {% else %}
            <span class="person-name">{{ assign.person }}</span>
            {% endif %}
            {% endif %}
            {% endif %}

            {% if assign.cover %}
            <span class="cover-indicator">(ðŸ”„ {{ assign.cover }})</span>
            {% endif %}
        </div>

        <div class="action-group">
            {% if assign.person == 'Select Helper' %}
            {% if not is_manager %}
            <button class="action-btn btn-help" hx-post="/action"
                hx-vals='{"type":"volunteer","date":"{{ full_date }}","idx":"{{ assign.idx }}"}'
                hx-target="#row-{{ full_date | replace(',','') | replace(' ','') }}-{{ assign.idx }}"
                hx-swap="outerHTML" title="I can help">
                <i class="fas fa-hand-paper"></i>
            </button>
            {% endif %}

            {% elif assign.status == 'confirmed' %}
            {% if is_manager or assign.person == current_user %}
            <button class="action-btn btn-undo" hx-post="/action"
                hx-vals='{"type":"undo","date":"{{ full_date }}","idx":"{{ assign.idx }}"}'
                hx-target="#row-{{ full_date | replace(',','') | replace(' ','') }}-{{ assign.idx }}"
                hx-swap="outerHTML" title="Undo"><i class="fas fa-undo"></i></button>
            {% else %}
            <div class="status-badge st-ok"><i class="fas fa-check"></i></div>
            {% endif %}

            {% elif assign.status == 'swap_needed' %}
            {% if assign.person == current_user %}
            <button class="action-btn btn-confirm" hx-post="/action"
                hx-vals='{"type":"undo","date":"{{ full_date }}","idx":"{{ assign.idx }}"}'
                hx-target="#row-{{ full_date | replace(',','') | replace(' ','') }}-{{ assign.idx }}"
                hx-swap="outerHTML" title="Undo"><i class="fas fa-undo"></i></button>
            {% else %}
            <div class="status-badge st-swap" title="Needs coverage"><i class="fas fa-exclamation"></i></div>
            {% endif %}

            {% else %}
            {% if is_manager or assign.person == current_user %}
            <button class="action-btn btn-confirm" hx-post="/action"
                hx-vals='{"type":"confirm","date":"{{ full_date }}","idx":"{{ assign.idx }}"}'
                hx-target="#row-{{ full_date | replace(',','') | replace(' ','') }}-{{ assign.idx }}"
                hx-swap="outerHTML"><i class="fas fa-check"></i></button>
            <button class="action-btn btn-decline" hx-post="/action"
                hx-vals='{"type":"decline","date":"{{ full_date }}","idx":"{{ assign.idx }}"}'
                hx-target="#row-{{ full_date | replace(',','') | replace(' ','') }}-{{ assign.idx }}"
                hx-swap="outerHTML" title="I can't make it"><i class="fas fa-times"></i></button>
            {% else %}
            <span class="status-pending">Pending</span>
            {% endif %}
            {% endif %}
        </div>
    </div>

    {# Swap-needed UI for OTHER users #}
    {% if assign.status == 'swap_needed' and current_user and current_user != assign.person %}
    <div class="swap-ui">
        {% if swap_options %}
        <form hx-post="/action" hx-target="#row-{{ full_date | replace(',','') | replace(' ','') }}-{{ assign.idx }}"
            hx-swap="outerHTML" style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
            <input type="hidden" name="type" value="swap_shift">
            <input type="hidden" name="date" value="{{ full_date }}">
            <input type="hidden" name="idx" value="{{ assign.idx }}">
            <select name="swap_offer_date" class="modern-select swap-select">
                {% for s in swap_options %}
                <option value="{{ s.date }}">Swap: {{ s.readable_date }}</option>
                {% endfor %}
            </select>
            <button class="action-btn btn-take">Swap</button>
        </form>
        {% else %}
        <button class="action-btn btn-take" hx-post="/action"
            hx-vals='{"type":"pickup","date":"{{ full_date }}","idx":"{{ assign.idx }}"}'
            hx-target="#row-{{ full_date | replace(',','') | replace(' ','') }}-{{ assign.idx }}"
            hx-swap="outerHTML">Pick up</button>
        {% endif %}
    </div>
    {% endif %}
</div>